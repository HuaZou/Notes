---
title: "stacked bar plot"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F)
library(ggplot2)
library(ggthemes)
library(extrafont)
library(plyr)
library(scales)
library(tidyverse)
```

### load data 
```{r}
charts.data <- read.csv("../dataSet/copper-data-for-tutorial.csv")
charts.data <- charts.data[rev(order(charts.data$product)), ]
```

### basic graph
 the **geom_bar** command

```{r}
charts.data$product <- factor(charts.data$product, levels = c("copper", "others"),
                              labels = c("Copper", "Pulp wood, Fruit, Salmon & Others"))
p4 <- ggplot() + geom_bar(aes(y = percentage, x = year, fill=product), data = charts.data,
                           stat="identity", color="black")
p4
```

### Adding data labels
 **label** argument to the **ggplot(aes())** 
```{r}
p4 <- p4 + geom_text(data=charts.data, aes(x = year, y = percentage,
                    label = paste0(percentage,"%")), size=4)
p4
```

### Adjusting data labels position
 **ddply** create a new variable called **pos** using **geom_text(aes())**
```{r}
charts.data <- ddply(charts.data, .(year),
                     transform, pos = cumsum(percentage)-( 0.5* percentage))

p4 <- ggplot() + geom_bar(aes(y = percentage, x = year, fill=product), data = charts.data,
                           stat="identity", color="black")
p4 <- p4 + geom_text(data=charts.data, aes(x = year, y = pos, label = paste0(percentage,"%")),
                       size=4)
p4
```

### Adjusting legend position
```{r}
p4 <- p4 + theme(legend.position="bottom", legend.direction="horizontal",
                   legend.title = element_blank())
p4
```

### Changing variables display
```{r}
p4 <- ggplot() + geom_bar(aes(y = percentage, x = year, fill = product), data = charts.data,
                           stat="identity", color="black") +
  geom_text(data=charts.data, aes(x = year, y = pos,
                                  label = paste0(percentage,"%")), size=4) +
  theme(legend.position="bottom", legend.direction="horizontal", legend.title = element_blank())
p4
```

### Adjusting x-axis scale
```{r}
p4 <- p4 + scale_x_continuous(breaks=seq(2006,2014,1))
p4
```

### Adjusting axis, title & units
```{r}
p4 <- p4 + labs(x="Year", y="Percentage") +
  scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
  ggtitle("Composition of Exports to China (%)")
p4
```

### Adjusting color palette 
```{r}
fill <- c("#5F9EA0", "#E1B378")
p4 <- p4 + scale_fill_manual(values=fill)
p4
```

### Using the white theme
```{r}
p4 <- ggplot() + theme_bw() +
  geom_bar(aes(y = percentage, x = year, fill = product), data = charts.data, stat="identity", color="black") +
  geom_text(data=charts.data, aes(x = year, y = pos, label = paste0(percentage,"%")), size=4) +
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank()) +
  scale_x_continuous(breaks=seq(2006,2014,1)) +
  scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
  labs(x="Year", y="Percentage") +
  ggtitle("Composition of Exports to China (%)")
p4
```
```{r, warning=FALSE, include=FALSE}
#download.file("http://simonsoftware.se/other/xkcd.ttf",dest="xkcd.ttf", mode="wb")
#system("mkdir ./.fonts")
#system("cp xkcd.ttf  ./.fonts")
# font_import(paths = "./.fonts", pattern="[X/x]kcd")
# loadfonts()
```
```{r, warning=FALSE}
fill <- c("#56B4E9", "#F0E442")

p4 <- ggplot() +
  geom_bar(aes(y = percentage, x = year, fill = product), data = charts.data, stat="identity", color="black") +
  geom_text(data=charts.data, aes(x = year, y = pos, label = paste0(percentage,"%")),
            colour="black", family="xkcd-Regular", size = 5, show.legend = F) +
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank()) +
  scale_x_continuous(breaks=seq(2006,2014,1)) +
  scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
  labs(x="Year", y="Percentage") +
  ggtitle("Composition of Exports to China (%)") +
  scale_fill_manual(values=fill) +
  theme(axis.line = element_line(size=1, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 14),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_blank(), panel.background = element_blank()) +
  theme(plot.title=element_text(family="xkcd-Regular"), text=element_text(family="xkcd-Regular"),
        axis.text.x=element_text(colour="black", size = 10),
        axis.text.y=element_text(colour="black", size = 10))
p4
```

### Using ‘The Economist’ theme
```{r, warning=FALSE}
p4 <- ggplot() + theme_economist() + scale_fill_economist() +
  theme(plot.title=element_text(family="OfficinaSanITC-Book"),
        text=element_text(family="OfficinaSanITC-Book")) +
  geom_bar(aes(y = percentage, x = year, fill = product), data = charts.data, stat="identity", color="black") +
  geom_text(data=charts.data, aes(x = year, y = pos, label = paste0(percentage,"%")),
            colour="white", family="OfficinaSanITC-Book", size=4) +
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(),plot.title = element_text(hjust = 0.5, size = 14)) +
  scale_x_continuous(breaks=seq(2006,2014,1)) +
  scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
  labs(x="Year", y="Percentage") +
  ggtitle("Composition of Exports to China (%)")
p4
```

### Using ‘Five Thirty Eight’ theme
```{r, warning=FALSE}
p4 <- ggplot() + theme_fivethirtyeight() + scale_fill_fivethirtyeight() +   
  theme(plot.title=element_text(family="Atlas Grotesk Medium"),
        text=element_text(family="Atlas Grotesk Light")) +
  geom_bar(aes(y = percentage, x = year, fill = product), data = charts.data, stat="identity", color="black") +
  geom_text(data=charts.data, aes(x = year, y = pos, label = paste0(percentage,"%")),
            colour="white", family="Atlas Grotesk Medium", size=4) +
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 14)) +
  scale_x_continuous(breaks=seq(2006,2014,1)) +
  scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
  labs(x="Year", y="Percentage") +
  ggtitle("Composition of Exports to China (%)")
p4
```

### Creating your own theme
```{r, warning=FALSE}
fill <- c("#40b8d0", "#b2d183")

p4 <- ggplot() +
  geom_bar(aes(y = percentage, x = year, fill = product), data = charts.data, stat="identity", color="black") +
  geom_text(data=charts.data, aes(x = year, y = pos, label = paste0(percentage,"%")),
            colour="black", family="Tahoma", size=4) +
  theme(legend.position="bottom", legend.direction="horizontal",
        legend.title = element_blank()) +
  scale_x_continuous(breaks=seq(2006,2014,1)) +
  scale_y_continuous(labels = dollar_format(suffix = "%", prefix = "")) +
  labs(x="Year", y="Percentage") +
  ggtitle("Composition of Exports to China (%)") +
  scale_fill_manual(values=fill) +
  theme(axis.line = element_line(size=1, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 14),
        panel.grid.major = element_line(colour = "#d3d3d3"), panel.grid.minor = element_blank(),
        panel.border = element_blank(), panel.background = element_blank()) +
  theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"),
        text=element_text(family="Tahoma"),
        axis.text.x=element_text(colour="black", size = 10),
        axis.text.y=element_text(colour="black", size = 10))
p4
```

Question: how to change order of stacked bar plot

### linkage stacked bar plot 
```{r}
df <- data.frame(
  Phylum=c("Ruminococcaceae","Bacteroidaceae","Eubacteriaceae","Lachnospiraceae","Porphyromonadaceae"),
  GroupA=c(37.7397,31.34317,222.08827,5.08956,3.7393),
  GroupB=c(113.2191,94.02951,66.26481,15.26868,11.2179),
  GroupC=c(123.2191,94.02951,46.26481,35.26868,1.2179),
  GroupD=c(37.7397,31.34317,222.08827,5.08956,3.7393)
)

df.long <- df %>% gather(group, abundance, -Phylum)
link_dat <- df %>% 
  arrange(by=desc(Phylum)) %>% 
  mutate_if(is.numeric, cumsum) 
bar.width <- 0.7
link_dat <- link_dat[, c(1,2,rep(3:(ncol(link_dat)-1),each=2), ncol(link_dat))]
link_dat <- data.frame(y=t(matrix(t(link_dat[,-1]), nrow=2)))
link_dat$x.1 <- 1:(ncol(df)-2)+bar.width/2
link_dat$x.2 <- 1:(ncol(df)-2)+(1-bar.width/2)

ggplot(df.long, aes(x=group, y=abundance, fill=Phylum)) + 
  geom_bar(stat = "identity", width=bar.width, col='black')  + 
  geom_segment(data=link_dat,
               aes(x=x.1, xend=x.2, y=y.1, yend=y.2), inherit.aes = F)
```